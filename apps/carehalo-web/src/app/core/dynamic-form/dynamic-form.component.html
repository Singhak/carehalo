<form [formGroup]="form" (ngSubmit)="onSubmit()" class="dynamic-form">
  <h2 *ngIf="formTitle">{{ formTitle }}</h2>
  
  <div class="form-grid">
    <ng-container *ngFor="let field of formFields">
      <div
        *ngIf="shouldDisplay(field)"
        class="form-field"
        [style.grid-column]="field.gridColumn"
      >
        <label [for]="field.name">{{ field.label }}</label>
        
        <ng-container [ngSwitch]="field.type">
          <input *ngSwitchCase="'text'" [type]="field.type" [id]="field.name" [formControl]="getControl(field.name)">
          <input *ngSwitchCase="'email'" [type]="field.type" [id]="field.name" [formControl]="getControl(field.name)">
          <input *ngSwitchCase="'password'" [type]="field.type" [id]="field.name" [formControl]="getControl(field.name)">
          <input *ngSwitchCase="'date'" [type]="field.type" [id]="field.name" [formControl]="getControl(field.name)">
          <input *ngSwitchCase="'phone'" type="tel" [id]="field.name" [formControl]="getControl(field.name)">
          
          <select *ngSwitchCase="'select'" [id]="field.name" [formControl]="getControl(field.name)">
            <option *ngFor="let option of field.options" [value]="option.value">{{ option.label }}</option>
          </select>
          
          <textarea *ngSwitchCase="'textarea'" [id]="field.name" [formControl]="getControl(field.name)" rows="3"></textarea>

          <div *ngSwitchCase="'form-array'" [formArrayName]="field.name">
            <h4>{{ field.label }}</h4>
            <div *ngFor="let group of getFormArray(field.name).controls; let i=index" [formGroupName]="i" class="form-array-group">
              <ng-container *ngFor="let subField of field.arrayFields ?? []">
                <div class="form-field">
                  <label [for]="subField.name + i">{{ subField.label }}</label>
                  <input [type]="subField.type" [id]="subField.name + i" [formControlName]="subField.name">
                </div>
              </ng-container>
              <button type="button" (click)="removeFormArrayGroup(field.name, i)">Remove</button>
            </div>
            <button type="button" (click)="addFormArrayGroup(field.name, field.arrayFields ?? [])">Add {{ field.label }}</button>
          </div>
        </ng-container>

        <div *ngIf="getControl(field.name)?.invalid && (getControl(field.name)?.dirty || getControl(field.name)?.touched)" class="error-message">
          <div *ngIf="getControl(field.name)?.errors?.['required']">{{ field.label }} is required.</div>
          <div *ngIf="getControl(field.name)?.errors?.['email']">Please enter a valid email address.</div>
          <div *ngIf="getControl(field.name)?.errors?.['pattern']">Invalid format.</div>
        </div>
      </div>
    </ng-container>
  </div>

  <button type="submit" [disabled]="form.invalid">{{ submitButtonText }}</button>
  
  <div *ngIf="showSuccess" class="success-message">Form submitted successfully!</div>
</form>
